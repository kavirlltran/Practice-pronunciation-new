<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Speech Evaluation Demo</title>
  <!-- Sử dụng font Roboto từ Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* Reset một số thiết lập và đảm bảo box-sizing cho mọi phần tử */
    * {
      box-sizing: border-box;
    }
    /* Global Styles */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      background-color: #121212;
      /* Hiệu ứng nền kiểu công nghệ dạng chấm */
      background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                        radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      color: #fff;
      line-height: 1.6;
      padding: 20px;
    }
    /* Container giúp căn giữa nội dung */
    .container {
      max-width: 600px;
      margin: auto;
      padding: 0 10px;
    }
    h1 {
      text-align: center;
      margin-top: 0;
      font-size: 2em;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    p {
      text-align: center;
      font-size: 1em;
      margin-bottom: 20px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    .sentence {
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      margin: 10px 0;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      border-radius: 8px;
      background-color: rgba(255,255,255,0.05);
    }
    .sentence.selected {
      background-color: rgba(0, 170, 255, 0.2);
      border-color: #00aaff;
      transform: scale(1.02);
    }
    .sentence span.word {
      margin-right: 5px;
      font-size: 1.1em;
      font-weight: 400;
    }
    /* Các từ trọng âm (content words) được tô màu xanh neon, đậm và có bóng chữ */
    .word.stressed {
      color: #00ff00;
      font-weight: 700;
      text-shadow: 0 0 5px rgba(0,255,0,0.5);
    }
    /* Từ đọc sai sẽ hiển thị màu đỏ */
    .word.error {
      color: #ff4444 !important;
      font-weight: 700;
      text-shadow: 0 0 5px rgba(255,0,0,0.7);
    }
    #controls {
      margin: 20px 0;
      text-align: center;
    }
    #recordBtn {
      padding: 12px 24px;
      font-size: 1.1em;
      border: none;
      border-radius: 8px;
      background-color: #00aaff;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #recordBtn:hover {
      background-color: #0088cc;
    }
    /* Biểu tượng âm thanh nhấp nháy */
    #recordIcon {
      display: inline-block;
      margin-left: 10px;
      width: 20px;
      height: 20px;
      background-color: #ff4444;
      border-radius: 50%;
      animation: pulse 1s infinite;
      vertical-align: middle;
    }
    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.6;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    #recordIcon.hidden {
      display: none;
    }
    #status {
      margin-top: 10px;
      font-size: 1em;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    #transcript {
      margin-top: 20px;
      font-style: italic;
      text-align: center;
      font-size: 1.1em;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    /* Media query cho điện thoại */
    @media (max-width: 600px) {
      h1 {
        font-size: 1.8em;
      }
      p, #status, #transcript {
        font-size: 1em;
      }
      #recordBtn {
        font-size: 1em;
        padding: 10px 20px;
      }
      .sentence span.word {
        font-size: 1em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Speech Evaluation Demo</h1>
    <p>
      Select one of the sentences below, then press the "Record" button and read the selected sentence. The system will record your voice, compare it with the original text, and highlight any mispronounced words in red. Content words are highlighted in green.
    </p>

    <div id="sentences"></div>

    <div id="controls">
      <button id="recordBtn">Record</button>
      <span id="recordIcon" class="hidden"></span>
      <p id="status"></p>
    </div>

    <div id="transcript"></div>
  </div>

  <script>
    // Danh sách 5 câu cho sẵn
    const sentences = [
      "We should finish the project for our history class",
      "Peter is revising for his exam next week",
      "Students will spend more time working with other classmates",
      "I like to watch videos that help me learn new things",
      "I have installed some apps on my phone"
    ];

    // Mapping của các từ trọng âm (content words) cho từng câu (đã chuyển về lower-case để so sánh)
    const contentWordsMapping = {
      0: ["finish", "project", "history", "class"],
      1: ["peter", "revising", "exam", "next", "week"],
      2: ["students", "spend", "time", "working", "other", "classmates"],
      3: ["like", "watch", "videos", "help", "learn", "new", "things"],
      4: ["installed", "apps", "phone"]
    };

    let selectedSentenceIndex = null;
    let isRecording = false;
    const sentencesDiv = document.getElementById("sentences");
    const recordBtn = document.getElementById("recordBtn");
    const recordIcon = document.getElementById("recordIcon");
    const statusEl = document.getElementById("status");
    const transcriptEl = document.getElementById("transcript");

    // Render danh sách các câu, với mỗi từ được đánh dấu nếu là content word theo mapping
    function renderSentences() {
      sentencesDiv.innerHTML = "";
      sentences.forEach((sentence, idx) => {
        const sentenceDiv = document.createElement("div");
        sentenceDiv.className = "sentence" + (idx === selectedSentenceIndex ? " selected" : "");
        sentenceDiv.addEventListener("click", () => {
          selectedSentenceIndex = idx;
          resetDisplay();
          renderSentences();
        });

        // Tách câu thành các từ
        sentence.split(" ").forEach((word) => {
          const span = document.createElement("span");
          span.classList.add("word");
          // Loại bỏ dấu câu và chuyển về lower-case để so sánh
          const normalizedWord = word.replace(/[.,?!]/g, "").toLowerCase();
          if (contentWordsMapping[idx] && contentWordsMapping[idx].includes(normalizedWord)) {
            span.classList.add("stressed");
          }
          span.textContent = word;
          sentenceDiv.appendChild(span);
        });
        sentencesDiv.appendChild(sentenceDiv);
      });
    }

    // Xóa nội dung transcript, status và xóa lớp lỗi của các từ
    function resetDisplay() {
      transcriptEl.textContent = "";
      statusEl.textContent = "";
      const sentenceDivs = document.querySelectorAll(".sentence");
      sentenceDivs.forEach((div) => {
        const spans = div.querySelectorAll("span.word");
        spans.forEach((span) => {
          span.classList.remove("error");
          // Nếu đây là câu đang được chọn, tái áp dụng lớp stressed nếu từ này nằm trong mapping
          const wordNormalized = span.textContent.replace(/[.,?!]/g, "").toLowerCase();
          if (selectedSentenceIndex !== null &&
              contentWordsMapping[selectedSentenceIndex] &&
              contentWordsMapping[selectedSentenceIndex].includes(wordNormalized)) {
            span.classList.add("stressed");
          }
        });
      });
    }

    renderSentences();

    // Hàm normalize: loại bỏ dấu câu và chuyển về lower-case
    function normalize(word) {
      return word.replace(/[.,?!]/g, "").toLowerCase();
    }

    // So sánh transcript nhận được với câu gốc, đánh dấu từ bị lỗi
    function evaluateTranscript(transcript) {
      if (selectedSentenceIndex === null) {
        alert("Please select a sentence before recording!");
        return;
      }
      const expectedSentence = sentences[selectedSentenceIndex];
      const expectedWords = expectedSentence.split(/\s+/);
      const recognizedWords = transcript.split(/\s+/);

      const sentenceDiv = sentencesDiv.children[selectedSentenceIndex];
      const wordSpans = sentenceDiv.querySelectorAll("span.word");

      let errorWords = [];
      expectedWords.forEach((word, idx) => {
        const normExpected = normalize(word);
        const normRecognized = normalize(recognizedWords[idx] || "");
        if (normExpected !== normRecognized) {
          if (wordSpans[idx]) {
            wordSpans[idx].classList.remove("stressed");
            wordSpans[idx].classList.add("error");
          }
          errorWords.push(word);
        }
      });

      transcriptEl.textContent = "Transcript: " + transcript;

      if (errorWords.length > 0) {
        statusEl.textContent = "Detected mispronunciations!";
        provideAudioGuidance(errorWords);
      } else {
        statusEl.textContent = "Perfect pronunciation!";
      }
    }

    // Phát gợi ý âm thanh cho các từ bị lỗi bằng SpeechSynthesis
    function provideAudioGuidance(errorWords) {
      const synth = window.speechSynthesis;
      const msgText = "Please listen and repeat the following words correctly: " + errorWords.join(", ");
      const utterThis = new SpeechSynthesisUtterance(msgText);
      utterThis.rate = 0.8;
      synth.speak(utterThis);
    }

    // Kiểm tra hỗ trợ SpeechRecognition của trình duyệt
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("Your browser does not support Speech Recognition. Please use Chrome or Edge.");
      recordBtn.disabled = true;
    } else {
      const recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = "en-US";

      recognition.onstart = function () {
        isRecording = true;
        statusEl.textContent = "Recording... Please read the selected sentence.";
        recordBtn.textContent = "Stop";
        recordIcon.classList.remove("hidden");
      };

      recognition.onerror = function (event) {
        statusEl.textContent = "Error occurred during recording: " + event.error;
        isRecording = false;
        recordBtn.textContent = "Record";
        recordIcon.classList.add("hidden");
      };

      recognition.onend = function () {
        isRecording = false;
        recordBtn.textContent = "Record";
        recordIcon.classList.add("hidden");
      };

      recognition.onresult = function (event) {
        const transcript = event.results[0][0].transcript;
        statusEl.textContent = "Recording finished. Evaluating...";
        evaluateTranscript(transcript);
      };

      // Khi nhấn nút, bắt đầu hoặc dừng ghi âm
      recordBtn.addEventListener("click", function () {
        if (selectedSentenceIndex === null) {
          alert("Please select a sentence before recording!");
          return;
        }
        resetDisplay();
        if (!isRecording) {
          recognition.start();
        } else {
          recognition.stop();
        }
      });
    }
  </script>
</body>
</html>
