<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Speech Evaluation Demo</title>
  <style>
    /* Tech-style animated background */
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      color: #fff;
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
    }
    @keyframes gradientBG {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }
    h1 {
      text-align: center;
      margin-top: 0;
    }
    p {
      text-align: center;
    }
    .sentence {
      padding: 10px;
      border: 1px solid #ddd;
      margin: 10px 0;
      cursor: pointer;
      transition: background-color 0.3s;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
    }
    .sentence.selected {
      background-color: rgba(0, 170, 255, 0.3);
      border-color: #00aaff;
    }
    .sentence span.word {
      margin-right: 5px;
      font-size: 18px;
    }
    /* Content words highlighted in bright green */
    .word.stressed {
      color: #00ff00;
    }
    /* Errors will be shown in red */
    .word.error {
      color: #ff0000 !important;
    }
    #controls {
      margin: 20px 0;
      text-align: center;
    }
    #recordBtn {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background-color: #00aaff;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #recordBtn:hover {
      background-color: #0088cc;
    }
    /* Flasing audio icon styling */
    #recordIcon {
      display: inline-block;
      margin-left: 10px;
      width: 20px;
      height: 20px;
      background-color: red;
      border-radius: 50%;
      animation: pulse 1s infinite;
      vertical-align: middle;
    }
    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.5;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    #recordIcon.hidden {
      display: none;
    }
    #status {
      margin-top: 10px;
    }
    #transcript {
      margin-top: 20px;
      font-style: italic;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Speech Evaluation Demo</h1>
  <p>
    Select one of the sentences below, then press the "Record" button and
    read the selected sentence. The system will record your voice, compare it
    with the original text, and highlight any mispronounced words in red.
    Content words are highlighted in green.
  </p>

  <div id="sentences"></div>

  <div id="controls">
    <button id="recordBtn">Record</button>
    <span id="recordIcon" class="hidden"></span>
    <p id="status"></p>
  </div>

  <div id="transcript"></div>

  <script>
    // List of 5 preset sentences
    const sentences = [
      "We should finish the project for our history class",
      "Peter is revising for his exam next week",
      "Students will spend more time working with other classmates",
      "I like to watch videos that help me learn new things",
      "I have installed some apps on my phone"
    ];

    // Simple stopwords list (words that are not considered content words)
    const stopWords = new Set([
      "a",
      "an",
      "the",
      "for",
      "our",
      "is",
      "are",
      "to",
      "and",
      "of",
      "in",
      "with",
      "on",
      "that",
      "should",
      "will",
      "more"
    ]);

    let selectedSentenceIndex = null;
    let isRecording = false;
    const sentencesDiv = document.getElementById("sentences");
    const recordBtn = document.getElementById("recordBtn");
    const recordIcon = document.getElementById("recordIcon");
    const statusEl = document.getElementById("status");
    const transcriptEl = document.getElementById("transcript");

    // Render the list of sentences
    function renderSentences() {
      sentencesDiv.innerHTML = "";
      sentences.forEach((sentence, idx) => {
        const sentenceDiv = document.createElement("div");
        sentenceDiv.className =
          "sentence" + (idx === selectedSentenceIndex ? " selected" : "");
        sentenceDiv.addEventListener("click", () => {
          selectedSentenceIndex = idx;
          resetDisplay();
          renderSentences();
        });

        // Split sentence into words and wrap each word in a span
        sentence.split(" ").forEach((word) => {
          const span = document.createElement("span");
          span.classList.add("word");
          // If not a stop word, consider it a content word and highlight it in green
          if (!stopWords.has(word.toLowerCase())) {
            span.classList.add("stressed");
          }
          span.textContent = word;
          sentenceDiv.appendChild(span);
        });
        sentencesDiv.appendChild(sentenceDiv);
      });
    }

    // Reset transcript and status display as well as word highlights
    function resetDisplay() {
      transcriptEl.textContent = "";
      statusEl.textContent = "";
      const sentenceDivs = document.querySelectorAll(".sentence");
      sentenceDivs.forEach((div) => {
        const spans = div.querySelectorAll("span.word");
        spans.forEach((span) => {
          span.classList.remove("error");
          if (!stopWords.has(span.textContent.toLowerCase())) {
            span.classList.add("stressed");
          }
        });
      });
    }

    renderSentences();

    // Normalize words by removing punctuation and converting to lowercase
    function normalize(word) {
      return word.replace(/[.,?!]/g, "").toLowerCase();
    }

    // Compare transcript with expected sentence and highlight mispronunciations
    function evaluateTranscript(transcript) {
      if (selectedSentenceIndex === null) {
        alert("Please select a sentence before recording!");
        return;
      }
      const expectedSentence = sentences[selectedSentenceIndex];
      const expectedWords = expectedSentence.split(/\s+/);
      const recognizedWords = transcript.split(/\s+/);

      const sentenceDiv = sentencesDiv.children[selectedSentenceIndex];
      const wordSpans = sentenceDiv.querySelectorAll("span.word");

      let errorWords = [];
      expectedWords.forEach((word, idx) => {
        const normExpected = normalize(word);
        const normRecognized = normalize(recognizedWords[idx] || "");
        if (normExpected !== normRecognized) {
          if (wordSpans[idx]) {
            wordSpans[idx].classList.remove("stressed");
            wordSpans[idx].classList.add("error");
          }
          errorWords.push(word);
        }
      });

      transcriptEl.textContent = "Transcript: " + transcript;

      if (errorWords.length > 0) {
        statusEl.textContent = "Detected mispronunciations!";
        provideAudioGuidance(errorWords);
      } else {
        statusEl.textContent = "Perfect pronunciation!";
      }
    }

    // Provide audio guidance for mispronounced words using SpeechSynthesis
    function provideAudioGuidance(errorWords) {
      const synth = window.speechSynthesis;
      const msgText =
        "Please listen and repeat the following words correctly: " +
        errorWords.join(", ");
      const utterThis = new SpeechSynthesisUtterance(msgText);
      // Slow down the speech rate for clarity
      utterThis.rate = 0.8;
      synth.speak(utterThis);
    }

    // Check for SpeechRecognition support
    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert(
        "Your browser does not support Speech Recognition. Please use Chrome or Edge."
      );
      recordBtn.disabled = true;
    } else {
      const recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = "en-US";

      recognition.onstart = function () {
        isRecording = true;
        statusEl.textContent = "Recording... Please read the selected sentence.";
        recordBtn.textContent = "Stop";
        recordIcon.classList.remove("hidden");
      };

      recognition.onerror = function (event) {
        statusEl.textContent = "Error occurred during recording: " + event.error;
        isRecording = false;
        recordBtn.textContent = "Record";
        recordIcon.classList.add("hidden");
      };

      recognition.onend = function () {
        isRecording = false;
        recordBtn.textContent = "Record";
        recordIcon.classList.add("hidden");
      };

      recognition.onresult = function (event) {
        const transcript = event.results[0][0].transcript;
        statusEl.textContent = "Recording finished. Evaluating...";
        evaluateTranscript(transcript);
      };

      // Start/Stop recording when the button is clicked
      recordBtn.addEventListener("click", function () {
        if (selectedSentenceIndex === null) {
          alert("Please select a sentence before recording!");
          return;
        }
        resetDisplay();
        if (!isRecording) {
          recognition.start();
        } else {
          recognition.stop();
        }
      });
    }
  </script>
</body>
</html>
